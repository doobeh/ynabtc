<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - YNAB Scotia Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Configuration</h1>
                <div class="space-x-4">
                    <a href="/emails" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Back to Emails</a>
                    <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Logout</a>
                </div>
            </div>
            
            <!-- Gmail Status -->
            <div class="mb-8 p-4 rounded-lg {% if gmail_status == 'Connected' %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}">
                <h2 class="text-lg font-semibold mb-2 {% if gmail_status == 'Connected' %}text-green-800{% else %}text-red-800{% endif %}">
                    Gmail API Status: {{ gmail_status }}
                </h2>
                <p class="{% if gmail_status == 'Connected' %}text-green-700{% else %}text-red-700{% endif %}">
                    {% if gmail_status == 'Connected' %}
                        ✓ Gmail API is configured and working properly
                    {% else %}
                        ✗ Gmail API not authenticated. Upload credentials and token files below.
                    {% endif %}
                </p>
            </div>
            
            <!-- Credentials File -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Gmail API Credentials</h2>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    {% if credentials_exists %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 font-medium">✓ credentials.json uploaded</p>
                                {% if credentials_info.get('error') %}
                                    <p class="text-red-500 text-sm">{{ credentials_info.error }}</p>
                                {% else %}
                                    <p class="text-sm text-gray-600">Client ID: {{ credentials_info.get('client_id', 'N/A') }}</p>
                                    <p class="text-sm text-gray-600">Project: {{ credentials_info.get('project_id', 'N/A') }}</p>
                                {% endif %}
                            </div>
                            <div class="space-x-2">
                                <a href="/config/download/credentials" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">Download</a>
                                <button onclick="deleteFile('credentials')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-red-600">✗ No credentials.json file found</p>
                        <p class="text-sm text-gray-600 mt-1">Upload your Google OAuth2 credentials from Google Cloud Console</p>
                    {% endif %}
                </div>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <form id="credentials-form" enctype="multipart/form-data" class="text-center">
                        <input type="file" id="credentials-file" accept=".json" class="hidden">
                        <input type="hidden" name="file_type" value="credentials">
                        <button type="button" onclick="document.getElementById('credentials-file').click()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                            Upload credentials.json
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Select your OAuth2 credentials file from Google Cloud Console</p>
                    </form>
                </div>
            </div>
            
            <!-- Token File -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Gmail API Token</h2>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    {% if token_exists %}
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 font-medium">✓ token.json uploaded</p>
                                {% if token_info.get('error') %}
                                    <p class="text-red-500 text-sm">{{ token_info.error }}</p>
                                {% else %}
                                    <p class="text-sm text-gray-600">Client ID: {{ token_info.get('client_id', 'N/A') }}</p>
                                    <p class="text-sm text-gray-600">Expires: {{ token_info.get('expiry', 'N/A') }}</p>
                                {% endif %}
                            </div>
                            <div class="space-x-2">
                                <a href="/config/download/token" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">Download</a>
                                <button onclick="deleteFile('token')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-red-600">✗ No token.json file found</p>
                        <p class="text-sm text-gray-600 mt-1">Upload your Gmail API token generated from OAuth flow</p>
                    {% endif %}
                </div>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <form id="token-form" enctype="multipart/form-data" class="text-center">
                        <input type="file" id="token-file" accept=".json" class="hidden">
                        <input type="hidden" name="file_type" value="token">
                        <button type="button" onclick="document.getElementById('token-file').click()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg">
                            Upload token.json
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Select your Gmail API token file (generated from OAuth flow)</p>
                    </form>
                </div>
            </div>
            
            <!-- Database Management -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Database Management</h2>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <p class="text-gray-700 mb-4">Manage the SQLite database that stores email records and transaction data.</p>
                    <div class="space-x-4">
                        <button onclick="initDatabase()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                            Initialize Database
                        </button>
                        <button onclick="resetDatabase()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            Reset Database (Clear All Data)
                        </button>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-yellow-800 text-sm">
                        <strong>Warning:</strong> Reset Database will permanently delete all stored email records and transaction data. Use with caution.
                    </p>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">Setup Instructions:</h3>
                <ol class="text-blue-700 text-sm space-y-1 ml-4 list-decimal">
                    <li>Get OAuth2 credentials from <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a></li>
                    <li>Download and upload credentials.json file</li>
                    <li>Run OAuth flow locally to generate token.json</li>
                    <li>Upload token.json file here</li>
                    <li>Gmail API will be ready for email monitoring</li>
                </ol>
            </div>
        </div>
    </div>
    
    <script>
        // File upload handling
        document.getElementById('credentials-file').addEventListener('change', function(e) {
            uploadFile('credentials', this.files[0]);
        });
        
        document.getElementById('token-file').addEventListener('change', function(e) {
            uploadFile('token', this.files[0]);
        });
        
        function uploadFile(type, file) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('file_type', type);
            
            fetch('/config/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Upload failed: ' + error, 'error');
            });
        }
        
        function deleteFile(type) {
            if (!confirm(`Are you sure you want to delete the ${type}.json file?`)) return;
            
            fetch(`/config/delete/${type}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Delete failed: ' + error, 'error');
            });
        }
        
        // Database management functions
        function initDatabase() {
            fetch('/config/init-db', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Database initialization failed: ' + error, 'error');
            });
        }
        
        function resetDatabase() {
            if (!confirm('Are you sure you want to reset the database? This will permanently delete ALL email records and transaction data!')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Are you absolutely sure you want to proceed?')) {
                return;
            }
            
            fetch('/config/reset-db', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Database reset failed: ' + error, 'error');
            });
        }
        
        function showMessage(message, type) {
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>